@using AdmIn.Business.Entidades
@using AdmIn.UI.Services
@inject IServ_Mock PersonaService

<div class="persona-selector" style="position:relative;">
    <RadzenTextBox @onclick="ToggleDropdown"
                   Value="@displayValue"
                   Placeholder="@Placeholder"
                   ReadOnly="true"
                   Style="width:100%; cursor:pointer; background-color:#f8f9fa;" />

    @if (mostrarDropdown)
    {
        <div class="persona-dropdown">
            @if (!mostrarFormularioNuevaPersona)
            {
                <div class="mb-2">
                    <input @bind="filtroApellido" placeholder="Buscar por Apellido" class="form-control" />
                    <input @bind="filtroRfc" placeholder="Buscar por RFC" class="form-control" />
                    <button class="btn btn-primary" @onclick="BuscarPersonas">Buscar</button>
                    <button class="btn btn-success ms-2" @onclick="MostrarFormularioNuevaPersona">Agregar Persona</button>
                    <button class="btn btn-secondary ms-2" @onclick="CerrarDropdown">Cerrar</button>
                </div>
                <RadzenDataGrid Data="@personas" TItem="PersonaBase" RowSelect="@SeleccionarPersona" ShowPagingSummary="true" PageSize="10">
                    <Columns>
                        <RadzenDataGridColumn TItem="PersonaBase" Property="Nombre" Title="Nombre" />
                        <RadzenDataGridColumn TItem="PersonaBase" Property="ApellidoPaterno" Title="Apellido Paterno" />
                        <RadzenDataGridColumn TItem="PersonaBase" Property="ApellidoMaterno" Title="Apellido Materno" />
                        <RadzenDataGridColumn TItem="PersonaBase" Property="Rfc" Title="RFC" />
                        <RadzenDataGridColumn TItem="PersonaBase" Property="Email" Title="Email" />
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <div class="mt-3 p-3 border rounded bg-light">
                    <h5>Nueva Persona</h5>
                    @if (!string.IsNullOrEmpty(mensajeError))
                    {
                        <div class="alert alert-danger">@mensajeError</div>
                    }
                    <EditForm Model="@nuevaPersona" OnValidSubmit="CrearPersona">
                        <InputText @bind-Value="nuevaPersona.Nombre" class="form-control mb-2" placeholder="Nombre" required />
                        <InputText @bind-Value="nuevaPersona.ApellidoPaterno" class="form-control mb-2" placeholder="Apellido Paterno" required />
                        <InputText @bind-Value="nuevaPersona.ApellidoMaterno" class="form-control mb-2" placeholder="Apellido Materno" required />
                        <InputText @bind-Value="nuevaPersona.Rfc" class="form-control mb-2" placeholder="RFC" required />
                        <InputText @bind-Value="nuevaPersona.Email" class="form-control mb-2" placeholder="Email" required />
                        <button class="btn btn-primary" type="submit">Crear</button>
                        <button class="btn btn-secondary ms-2" type="button" @onclick="CancelarAgregarPersona">Cancelar</button>
                    </EditForm>
                </div>
            }
        </div>
    }
</div>

<style>
    .persona-dropdown {
        position: absolute;
        left: 0;
        right: 0;
        z-index: 1000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.12);
        padding: 18px 18px 12px 18px;
        margin-top: 2px;
        min-width: 350px;
        max-width: 100vw;
    }
</style>

@code {
    [Parameter] public EventCallback<PersonaBase> OnPersonaSelected { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Seleccionar persona";
    [Parameter] public string Titulo { get; set; } = "Buscar o crear persona";

    private List<PersonaBase> personas = new();
    private string filtroApellido = string.Empty;
    private string filtroRfc = string.Empty;
    private bool mostrarFormularioNuevaPersona = false;
    private PersonaBase nuevaPersona = new();
    private bool mostrarDropdown = false;
    private PersonaBase? personaSeleccionada;
    private string? mensajeError;
    private string displayValue => personaSeleccionada != null
        ? $"({personaSeleccionada.Rfc}) {personaSeleccionada.Nombre} {personaSeleccionada.ApellidoPaterno} {personaSeleccionada.ApellidoMaterno}"
        : Placeholder;

    private void ToggleDropdown()
    {
        mostrarDropdown = !mostrarDropdown;
        if (mostrarDropdown)
        {
            _ = BuscarPersonas();
        }
    }

    private void CerrarDropdown()
    {
        mostrarDropdown = false;
        mostrarFormularioNuevaPersona = false;
    }

    private async Task BuscarPersonas()
    {
        personas = await PersonaService.BuscarPersonasAsync(filtroApellido, filtroRfc);
        mostrarFormularioNuevaPersona = false;
        StateHasChanged();
    }

    private async Task SeleccionarPersona(PersonaBase persona)
    {
        personaSeleccionada = persona;
        mostrarDropdown = false;
        mostrarFormularioNuevaPersona = false;
        if (OnPersonaSelected.HasDelegate)
            await OnPersonaSelected.InvokeAsync(persona);
    }

    private void MostrarFormularioNuevaPersona()
    {
        nuevaPersona = new PersonaBase();
        mostrarFormularioNuevaPersona = true;
    }

    private void CancelarAgregarPersona()
    {
        mostrarFormularioNuevaPersona = false;
    }

    private async Task CrearPersona()
    {
        // Validación simple (todos los campos requeridos)
        if (string.IsNullOrWhiteSpace(nuevaPersona.Nombre) ||
            string.IsNullOrWhiteSpace(nuevaPersona.ApellidoPaterno) ||
            string.IsNullOrWhiteSpace(nuevaPersona.ApellidoMaterno) ||
            string.IsNullOrWhiteSpace(nuevaPersona.Rfc) ||
            string.IsNullOrWhiteSpace(nuevaPersona.Email))
        {
            mensajeError = "Todos los campos son requeridos.";
            StateHasChanged();
            return;
        }

        mensajeError = null;
        var personaCreada = await PersonaService.CrearPersonaAsync(nuevaPersona);
        mostrarFormularioNuevaPersona = false;
        personaSeleccionada = personaCreada;
        mostrarDropdown = false;
        if (OnPersonaSelected.HasDelegate)
            await OnPersonaSelected.InvokeAsync(personaCreada);
        StateHasChanged();
    }
}
